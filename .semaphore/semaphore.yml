version: v1.0
name: Benchmarking suite
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
execution_time_limit:
  hours: 24
blocks:
  - name: Setup
    dependencies: []
    task:
      jobs:
        - name: setup
          commands:
            - checkout
            - cache store $SEMAPHORE_GIT_SHA .
            - sudo apt-get update
            - sudo apt-get install build-essential libssl-dev git -y
            - "git clone https://github.com/wg/wrk.git wrk"
            - cd wrk && make
            - cache store wrk wrk
            - bundle config path .cache
            - bundle install
            - cache store built-in .cache
            - bundle exec rake config
  - name: Ruby
    dependencies:
      - Setup
    run:
      when: change_in('/ruby/')
    task:
      prologue:
        commands:
          - cache restore $SEMAPHORE_GIT_SHA
          - cache restore wrk
          - sudo install wrk /usr/local/bin
          - cache restore bin
          - cache restore built-in
          - sem-service start postgres
          - createdb -U postgres -h 0.0.0.0 benchmark
          - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
          - bundle config path .cache
          - bundle install
          - bundle exec rake config
      jobs:
        - name: setup
          commands:
            - checkout
  - name: Rails
    dependencies:
      - Ruby
    task:
      env_vars:
        - name: LANGUAGE
          value: ruby
        - name: FRAMEWORK
          value: rails
      prologue:
        commands:
          - cache restore $SEMAPHORE_GIT_SHA
          - cache restore wrk
          - sudo install wrk /usr/local/bin
          - cache restore bin
          - cache restore built-in
          - sem-service start postgres
          - createdb -U postgres -h 0.0.0.0 benchmark
          - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
          - bundle config path .cache
          - bundle install
          - bundle exec rake config
      jobs:
        - name: puma
          commands:
            - cd ruby/rails && make build.puma  -f .Makefile  && cd -
            - bundle exec rspec .spec
            - make  -f ruby/rails/.Makefile collect.puma
            - bundle exec rake db:export
          env_vars:
            - name: VARIANT
              value: puma
        - name: falcon
          commands:
            - cd ruby/rails && make build.falcon  -f .Makefile  && cd -
            - bundle exec rspec .spec
            - make  -f ruby/rails/.Makefile collect.falcon
            - bundle exec rake db:export
          env_vars:
            - name: VARIANT
              value: falcon
        - name: iodine
          commands:
            - cd ruby/rails && make build.iodine  -f .Makefile  && cd -
            - bundle exec rspec .spec
            - make  -f ruby/rails/.Makefile collect.iodine
            - bundle exec rake db:export
          env_vars:
            - name: VARIANT
              value: iodine
  - name: Sinatra
    dependencies:
      - Ruby
    task:
      env_vars:
        - name: LANGUAGE
          value: ruby
        - name: FRAMEWORK
          value: sinatra
      prologue:
        commands:
          - cache restore $SEMAPHORE_GIT_SHA
          - cache restore wrk
          - sudo install wrk /usr/local/bin
          - cache restore bin
          - cache restore built-in
          - sem-service start postgres
          - createdb -U postgres -h 0.0.0.0 benchmark
          - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
          - bundle config path .cache
          - bundle install
          - bundle exec rake config
      jobs:
        - name: puma
          commands:
            - cd ruby/sinatra && make build.puma  -f .Makefile  && cd -
            - bundle exec rspec .spec
            - make  -f ruby/sinatra/.Makefile collect.puma
            - bundle exec rake db:export
          env_vars:
            - name: VARIANT
              value: puma
        - name: falcon
          commands:
            - cd ruby/sinatra && make build.sinatra  -f .Makefile  && cd -
            - bundle exec rspec .spec
            - make  -f ruby/sinatra/.Makefile collect.falcon
            - bundle exec rake db:export
          env_vars:
            - name: VARIANT
              value: falcon
        - name: iodine
          commands:
            - cd ruby/sinatra && make build.iodine  -f .Makefile  && cd -
            - bundle exec rspec .spec
            - make  -f ruby/sinatra/.Makefile collect.iodine
            - bundle exec rake db:export
          env_vars:
            - name: VARIANT
              value: iodine
  - name: Grape
    dependencies:
      - Ruby
    task:
      env_vars:
        - name: LANGUAGE
          value: ruby
        - name: FRAMEWORK
          value: grape
      prologue:
        commands:
          - cache restore $SEMAPHORE_GIT_SHA
          - cache restore wrk
          - sudo install wrk /usr/local/bin
          - cache restore bin
          - cache restore built-in
          - sem-service start postgres
          - createdb -U postgres -h 0.0.0.0 benchmark
          - psql -U postgres -h 0.0.0.0 -d benchmark < dump.sql
          - bundle config path .cache
          - bundle install
          - bundle exec rake config
      jobs:
        - name: puma
          commands:
            - cd ruby/grape && make build.puma  -f .Makefile  && cd -
            - bundle exec rspec .spec
            - make  -f ruby/grape/.Makefile collect.puma
            - bundle exec rake db:export
          env_vars:
            - name: VARIANT
              value: puma
        - name: falcon
          commands:
            - cd ruby/grape && make build.falcon  -f .Makefile  && cd -
            - bundle exec rspec .spec
            - make  -f ruby/grape/.Makefile collect.falcon
            - bundle exec rake db:export
          env_vars:
            - name: VARIANT
              value: falcon
        - name: iodine
          commands:
            - cd ruby/grape && make build.iodine  -f .Makefile  && cd -
            - bundle exec rspec .spec
            - make  -f ruby/grape/.Makefile collect.iodine
            - bundle exec rake db:export
          env_vars:
            - name: VARIANT
              value: iodine
